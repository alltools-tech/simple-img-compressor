<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Manifest and theme -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#21d4fd" />

  <!-- Google site verification (fixed) -->
  <meta name="google-site-verification" content="omReey7kjqSBJiJtRHiduTHCim7RroqTu9pO0sjJLes">

  <!-- Core meta -->
  <title>Smart Image Compressor and Converter — Fast Online Free Tool</title>
  <meta name="description" content="Compress and convert images instantly! Smart Image Compressor and Converter supports JPEG, PNG, WebP, AVIF, HEIC, HEIF, BMP. 100% free, secure & privacy-friendly. No upload required.">
  <meta name="keywords" content="image compressor, image converter, free online image tool, compress images, convert images, JPEG compressor, PNG compressor, WebP converter, AVIF converter, HEIC converter, resize images, privacy image tool, fast image compression, online image optimizer, Smart Image Compressor">
  <meta name="author" content="Smart Image Compressor | skycommunics@gmail.com">
  <meta name="contact" content="skycommunics@gmail.com">

  <!-- Canonical + Open Graph -->
  <link rel="canonical" href="https://simple-img-compressor.vercel.app/">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://simple-img-compressor.vercel.app/">
  <meta property="og:title" content="Smart Image Compressor and Converter — Fast Online Free Tool">
  <meta property="og:description" content="Compress and convert images (JPEG, PNG, WebP, AVIF, HEIC, HEIF, BMP) online for free — no uploads needed. Super fast, privacy-first, and easy to use!">
  <meta property="og:image" content="https://simple-img-compressor.vercel.app/og-image.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://simple-img-compressor.vercel.app/">
  <meta name="twitter:title" content="Smart Image Compressor and Converter — Fast Online Free Tool">
  <meta name="twitter:description" content="Compress and convert images (JPEG, PNG, WebP, AVIF, HEIC, HEIF, BMP) online for free — no uploads needed. Super fast, privacy-first, and easy to use!">
  <meta name="twitter:image" content="https://simple-img-compressor.vercel.app/og-image.jpg">

  <link rel="icon" href="https://simple-img-compressor.vercel.app/favicon.ico" type="image/x-icon">

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

  <!-- Google Analytics (gtag) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-R0K1T489JY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-R0K1T489JY');
  </script>

  <!-- Adsense (kept) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7604876231244458" crossorigin="anonymous"></script>

  <!-- Inline styles (kept theme you provided) -->
  <style>
    :root{
      --accent-1:#2196f3;
      --accent-2:#21cbf3;
      --bg-1:linear-gradient(135deg,#0f2027 0%,#2c5364 100%);
      --panel:#ffffff;
      --muted:#777;
      --success:#2e7d32;
      --danger:#cb2431;
    }
    html,body{height:100%;margin:0;font-family:'Inter',Arial,sans-serif;background:var(--bg-1);color:#222}
    header{background:linear-gradient(90deg,#004400 0%,#0e4f1f 100%);color:#fff;padding:1.1em 0;border-bottom:2px solid var(--accent-1);display:flex;align-items:center;justify-content:center;min-height:72px}
    .main-title{font-size:2.1em;font-weight:900;letter-spacing:.02em;color:#fff;text-shadow:0 3px 16px #084b22;margin:0}
    main{max-width:980px;margin:2em auto;background:var(--panel);padding:2em;border-radius:16px;box-shadow:0 4px 32px rgba(33,150,243,0.07)}
    .upload-zone{border:2px dashed #90caf9;border-radius:10px;background:#e3f2fd;padding:2em 1em;text-align:center;color:#1976d2;font-size:1.15em;margin-bottom:1.5em;cursor:pointer}
    .upload-zone.dragover{background:#bbdefb;border-color:var(--accent-1);color:#0d47a1}
    .upload-btn-group{margin-top:1em;display:flex;gap:1em;justify-content:center;flex-wrap:wrap}
    .upload-btn{padding:.65em 1.4em;background:linear-gradient(90deg,var(--accent-1) 60%,var(--accent-2));color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer}
    .supported-types{color:#1565c0;font-size:.98em;margin-top:10px;background:#e8eaf6;border-radius:5px;display:inline-block;padding:4px 14px;font-weight:500}
    .preview-row{display:flex;gap:2em;align-items:flex-start;margin-bottom:1em;justify-content:center;flex-wrap:wrap}
    .card{background:#f7fbff;border-radius:10px;padding:1.2em;min-width:240px;max-width:340px;text-align:center;flex:1;position:relative;box-shadow:0 2px 12px rgba(33,150,243,0.04)}
    .preview-img{width:100%;max-width:300px;max-height:200px;border-radius:8px;margin-bottom:.4em;cursor:pointer;object-fit:contain;background:#fff;outline:2px solid #90caf9;outline-offset:2px}
    .preview-img:hover{box-shadow:0 8px 32px #42a5f5aa;outline-color:#1976d2}
    .zoom-modal{display:none;position:fixed;z-index:99;left:0;top:0;width:100vw;height:100vh;background:rgba(33,150,243,0.15);align-items:center;justify-content:center}
    .zoom-modal img{max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 4px 40px #2196f3bb;background:#fff}
    .info-row{font-size:1em;color:var(--success);margin-bottom:.7em;line-height:1.4}
    .range-row{display:flex;align-items:center;gap:1em}
    .btn{padding:.6em 1.5em;background:linear-gradient(90deg,var(--accent-1) 60%,var(--accent-2));color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer}
    .btn:disabled{background:#aec4e6;cursor:not-allowed}
    .reset-btn{padding:.4em 1.1em;background:#bbb;color:#fff;border-radius:4px;border:none;font-weight:600;cursor:pointer}
    .footer{text-align:center;color:#999;font-size:.98em;margin:2.5em 0 0.3em}
    #about-modal-bg{display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,32,32,0.23);align-items:center;justify-content:center}
    #about-popup{background:#e3f2fd;border-radius:16px;max-width:720px;border:2px solid #90caf9;padding:1em 1.2em;color:#185a9d;line-height:1.6}
    #about-close{position:absolute;right:13px;top:10px;background:transparent;border:none;color:#185a9d;font-size:1.45em;font-weight:bold;cursor:pointer}
    @media (max-width:900px){.preview-row{flex-direction:column;gap:1em}.card{max-width:99vw}}
    /* style for More Tools button (small variant) */
    .more-tools {
      padding: .46em 1em;
      border-radius: 6px;
      background: linear-gradient(90deg,var(--accent-2) 10%,var(--accent-1));
      color: #06314a;
      border: none;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    @media (max-width:480px){
      .more-tools { padding: .42em .8em; font-size: 0.92em; }
    }
  </style>
</head>
<body>
  <nav style="padding:.6em 1em;background:rgba(255,255,255,0.02);color:#fff;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <button class="nav-toggle" aria-label="Show menu" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:.4em .8em;border-radius:6px;cursor:pointer">☰ Menu</button>
    <a href="index.html" style="color:#fff;text-decoration:none;font-weight:600">Home</a>
    <a href="about.html" style="color:#fff;text-decoration:none">About</a>
    <a href="privacy.html" style="color:#fff;text-decoration:none">Privacy</a>
    <a href="terms.html" style="color:#fff;text-decoration:none">Terms</a>
    <a href="contact.html" style="color:#fff;text-decoration:none">Contact</a>
  </nav>

  <header><span class="main-title">Smart Image Compressor and Converter</span></header>

  <main>
    <!-- Upload zone -->
    <div id="uploadZone" class="upload-zone" tabindex="0">
      <div><strong>Drag &amp; Drop</strong> or use <strong>buttons below</strong> to upload / capture image</div>
      <div class="supported-types">Supported: JPEG, PNG, WebP, <span style="color:#2e7d32">AVIF, HEIC, HEIF, BMP</span></div>
      <div class="upload-btn-group" style="margin-top:1rem">
        <button id="galleryBtn" class="upload-btn" type="button">Upload from Gallery</button>
        <button id="cameraBtn" class="upload-btn" type="button">Capture from Camera</button>
      </div>
      <!-- hidden file inputs -->
      <input type="file" id="galleryInput" accept="image/jpeg,image/png,image/webp,image/avif,image/heic,image/heif,image/bmp,image/*" style="display:none">
      <input type="file" id="cameraInput" accept="image/jpeg,image/png,image/webp,image/avif,image/heic,image/heif,image/bmp,image/*" style="display:none">
    </div>

    <!-- Preview cards -->
    <div class="preview-row">
      <div class="card" id="originalCard">
        <div style="font-weight:600;margin-bottom:6px">Original</div>
        <img id="originalPreview" class="preview-img" src="" alt="Original" style="display:none" crossorigin="anonymous">
        <div style="margin-top:10px">
          <button id="openCropBtn" class="btn" style="display:none">Crop Image</button>
          <button id="rotateBtn" class="btn" style="display:none">Rotate 90°</button>
        </div>
        <div id="originalInfo" class="info-row"></div>
      </div>

      <div class="card" id="compressedCard">
        <div style="font-weight:600;margin-bottom:6px">Compressed</div>
        <img id="compressedPreview" class="preview-img" src="" alt="Compressed" style="display:none" crossorigin="anonymous">
        <div id="compressedInfo" class="info-row"></div>
      </div>
    </div>

    <!-- Controls -->
    <div style="margin:1.5em 0 1em 0">
      <div class="range-row" id="qualityRow" style="align-items:center">
        <label for="qualityRange" style="min-width:70px">Quality:</label>
        <input type="range" id="qualityRange" min="10" max="100" value="80" style="flex:1">
        <span id="qualityValue" style="min-width:36px;text-align:center">80</span>%
      </div>

      <div style="display:flex;gap:1em;flex-wrap:wrap;margin-top:.8em;align-items:center">
        <div>
          <div style="font-weight:600;margin-bottom:.4em">Resize Units</div>
          <label><input type="radio" name="resizeUnit" value="cm" checked> cm</label>
          <label style="margin-left:.6em"><input type="radio" name="resizeUnit" value="inch"> inch</label>
          <label style="margin-left:.6em"><input type="radio" name="resizeUnit" value="px"> px</label>
        </div>

        <div style="min-width:160px">
          <div style="font-weight:600;margin-bottom:.4em">Dimensions</div>
          <div style="display:flex;gap:.6em;align-items:center">
            <div>
              <label style="display:block;font-size:.9em">Width (<span id="unitLabelW">cm</span>)</label>
              <input type="number" id="resizeWidth" min="0.0001" step="any" placeholder="Original width" style="width:120px">
            </div>
            <div>
              <label style="display:block;font-size:.9em">Height (<span id="unitLabelH">cm</span>)</label>
              <input type="number" id="resizeHeight" min="0.0001" step="any" placeholder="Original height" style="width:120px">
            </div>
            <button id="resetResize" class="reset-btn" title="Reset to original">Reset</button>
          </div>
        </div>

        <div>
          <label style="display:block;margin-bottom:.4em"><input type="checkbox" id="aspectLock" checked> Unlock Aspect Ratio</label>
        </div>
      </div>

      <div style="margin-top:1em;display:flex;gap:1em;flex-wrap:wrap;align-items:center">
        <label style="display:flex;align-items:center;gap:.6em">
          <input type="checkbox" id="enableSaveAs" checked> Save image as
        </label>
        <input type="text" id="saveFilename" placeholder="compressed_image" style="width:160px">
        <select id="saveFormat" class="select-format" style="padding:.5em;border-radius:6px">
          <option value="auto">Same as original</option>
          <option value="image/jpeg">JPEG (.jpg)</option>
          <option value="image/png">PNG (.png)</option>
          <option value="image/webp">WebP (.webp)</option>
          <option value="image/avif">AVIF (.avif)</option>
          <option value="image/heic">HEIC (.heic)</option>
          <option value="image/heif">HEIF (.heif)</option>
          <option value="image/bmp">BMP (.bmp)</option>
        </select>
      </div>

      <div style="margin-top:1em;display:flex;gap:.8em;align-items:center;flex-wrap:wrap">
        <button id="compressBtn" class="btn" disabled>Compress Image</button>

        <!-- Download + More Tools button group -->
        <div style="display:flex;gap:.6em;align-items:center">
          <button id="downloadBtn" class="btn" disabled>Download Compressed</button>
          <button id="moreToolsBtn" class="more-tools" type="button" title="More tools at skycommunics.com">More Tools</button>
        </div>

        <span id="msg" style="color:var(--danger);margin-left:.6em"></span>
      </div>
    </div>

    <!-- Zoom & Crop Modals -->
    <div id="zoomModal" class="zoom-modal" aria-hidden="true" role="dialog">
      <img id="zoomImg" alt="Zoomed" />
    </div>

    <div id="cropModal" class="zoom-modal" aria-hidden="true" role="dialog">
      <div style="background:#fff;padding:18px;border-radius:10px;max-width:99vw;max-height:96vh;overflow:auto">
        <img id="cropImg" src="" style="max-width:80vw;max-height:60vh" crossorigin="anonymous" alt="Crop preview">
        <div style="text-align:center;margin-top:12px">
          <button id="cropConfirmBtn" class="btn">Crop &amp; Use</button>
          <button id="cropCancelBtn" class="reset-btn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- About -->
    <div id="about-modal-bg">
      <div id="about-popup" role="dialog" aria-modal="true" aria-labelledby="about-title">
        <button id="about-close" aria-label="Close about">&times;</button>
        <h2 id="about-title">About Smart Image Compressor and Converter</h2>
        <p><strong>Smart Image Compressor and Converter</strong> is a free, privacy-focused image tool. Compress and convert images right in your browser — no uploads, no watermarks.</p>
        <h3>Special Features</h3>
        <ul>
          <li><strong>Privacy:</strong> All processing happens locally in your browser.</li>
          <li><strong>Formats:</strong> JPEG, PNG, WebP, AVIF, HEIC, HEIF, BMP.</li>
          <li><strong>Tools:</strong> Crop, rotate, resize, aspect lock, select output format, filename.</li>
          <li><strong>Mobile friendly:</strong> Works on phones, tablets and desktops.</li>
        </ul>
        <p>Contact: <a href="mailto:skycommunics@gmail.com">skycommunics@gmail.com</a></p>
      </div>
    </div>
  </main>

  <footer class="footer">
    &copy; 2025 Smart Image Compressor | Fast, Free & Secure
    <button class="about-btn-footer" id="aboutBtnFooter" style="margin-left:12px;padding:.3em .9em;border-radius:12px;border:1px solid #cfe9ff;background:#e3f2fd;color:#185a9d">About</button>
  </footer>

  <!-- Main script (deferred logic) -->
  <script>
  // --- UI wiring and logic preserved from original file, cleaned for well-formedness ---
  document.addEventListener('DOMContentLoaded', function () {
    // Elements
    const uploadZone = document.getElementById('uploadZone');
    const galleryBtn = document.getElementById('galleryBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const galleryInput = document.getElementById('galleryInput');
    const cameraInput = document.getElementById('cameraInput');
    const originalPreview = document.getElementById('originalPreview');
    const compressedPreview = document.getElementById('compressedPreview');
    const originalInfo = document.getElementById('originalInfo');
    const compressedInfo = document.getElementById('compressedInfo');
    const qualityRange = document.getElementById('qualityRange');
    const qualityValue = document.getElementById('qualityValue');
    const resizeWidth = document.getElementById('resizeWidth');
    const resizeHeight = document.getElementById('resizeHeight');
    const unitRadios = document.getElementsByName('resizeUnit');
    const unitLabelW = document.getElementById('unitLabelW');
    const unitLabelH = document.getElementById('unitLabelH');
    const compressBtn = document.getElementById('compressBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetResize = document.getElementById('resetResize');
    const msg = document.getElementById('msg');
    const zoomModal = document.getElementById('zoomModal');
    const zoomImg = document.getElementById('zoomImg');
    const openCropBtn = document.getElementById('openCropBtn');
    const cropModal = document.getElementById('cropModal');
    const cropImg = document.getElementById('cropImg');
    const cropConfirmBtn = document.getElementById('cropConfirmBtn');
    const cropCancelBtn = document.getElementById('cropCancelBtn');
    const saveFilename = document.getElementById('saveFilename');
    const enableSaveAs = document.getElementById('enableSaveAs');
    const saveFormat = document.getElementById('saveFormat');
    const qualityRow = document.getElementById('qualityRow');
    const rotateBtn = document.getElementById('rotateBtn');
    const aspectLock = document.getElementById('aspectLock');
    const aboutBtnFooter = document.getElementById('aboutBtnFooter');
    const aboutModalBg = document.getElementById('about-modal-bg');
    const aboutClose = document.getElementById('about-close');
    const moreToolsBtn = document.getElementById('moreToolsBtn');

    // state variables (kept same)
    let cropper = null;
    let originalFile = null;
    let compressedBlob = null;
    let loadedImage = null;
    let originalType = "";
    let origWidth = null, origHeight = null;
    let blockResizeSync = false;
    let lastOutMime = "";
    let rotation = 0;
    let isAspectLocked = aspectLock.checked;
    const DECIMALS = 4;
    function getDPI() { return 96; }
    function unitConvert(val, from, to) {
      if (!val && val !== 0) return '';
      const dpi = getDPI();
      switch(from + '-' + to) {
        case 'px-cm': return (val / dpi * 2.54).toFixed(DECIMALS);
        case 'px-inch': return (val / dpi).toFixed(DECIMALS);
        case 'cm-px': return Math.round(val * dpi / 2.54);
        case 'inch-px': return Math.round(val * dpi);
        default: return val;
      }
    }

    // About modal
    aboutBtnFooter.onclick = function() {
      aboutModalBg.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };
    aboutClose.onclick = function() {
      aboutModalBg.style.display = 'none';
      document.body.style.overflow = '';
    };
    aboutModalBg.onclick = function(e) {
      if (e.target === aboutModalBg) {
        aboutModalBg.style.display = 'none';
        document.body.style.overflow = '';
      }
    };

    // File inputs wiring
    galleryBtn.addEventListener('click', () => { galleryInput.value = ""; galleryInput.click(); });
    cameraBtn.addEventListener('click', () => { cameraInput.value = ""; cameraInput.setAttribute('capture','user'); cameraInput.click(); });

    galleryInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
    });

    cameraInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
      cameraInput.removeAttribute('capture');
    });

    // Drag & drop
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', (e) => { e.preventDefault(); uploadZone.classList.remove('dragover'); });
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    // Aspect lock & input sync
    aspectLock.addEventListener('change', () => { isAspectLocked = aspectLock.checked; });

    qualityRange.addEventListener('input', function() { qualityValue.textContent = this.value; });

    enableSaveAs.addEventListener('change', function() {
      if (enableSaveAs.checked) { saveFilename.disabled = false; saveFilename.style.opacity = "1"; }
      else { saveFilename.disabled = true; saveFilename.style.opacity = "0.6"; }
    });

    saveFormat.addEventListener('change', function() {
      if (saveFormat.value === "image/png") qualityRow.style.display = "none";
      else qualityRow.style.display = "";
    });

    function getSelectedUnit() {
      let selectedUnit = 'cm';
      unitRadios.forEach(radio => { if (radio.checked) selectedUnit = radio.value; });
      return selectedUnit;
    }
    function updateUnitLabels(forceAutofill) {
      let selectedUnit = getSelectedUnit();
      unitLabelW.textContent = selectedUnit;
      unitLabelH.textContent = selectedUnit;
      if (loadedImage) {
        const origW = loadedImage.width, origH = loadedImage.height;
        if (selectedUnit === 'cm') {
          resizeWidth.placeholder = unitConvert(origW, 'px', 'cm');
          resizeHeight.placeholder = unitConvert(origH, 'px', 'cm');
          if (forceAutofill) {
            resizeWidth.value = parseFloat(unitConvert(origW, 'px', 'cm')).toFixed(DECIMALS);
            resizeHeight.value = parseFloat(unitConvert(origH, 'px', 'cm')).toFixed(DECIMALS);
          }
          resizeWidth.step = "0.0001"; resizeHeight.step = "0.0001";
        } else if (selectedUnit === 'inch') {
          resizeWidth.placeholder = unitConvert(origW, 'px', 'inch');
          resizeHeight.placeholder = unitConvert(origH, 'px', 'inch');
          if (forceAutofill) {
            resizeWidth.value = parseFloat(unitConvert(origW, 'px', 'inch')).toFixed(DECIMALS);
            resizeHeight.value = parseFloat(unitConvert(origH, 'px', 'inch')).toFixed(DECIMALS);
          }
          resizeWidth.step = "0.0001"; resizeHeight.step = "0.0001";
        } else {
          resizeWidth.placeholder = origW; resizeHeight.placeholder = origH;
          if (forceAutofill) {
            resizeWidth.value = Math.round(origW); resizeHeight.value = Math.round(origH);
          }
          resizeWidth.step = "1"; resizeHeight.step = "1";
        }
      }
    }
    Array.from(unitRadios).forEach(radio => radio.addEventListener('change', () => { updateUnitLabels(true); }));

    function aspectRatio() { if (!origWidth || !origHeight) return 1; return origWidth / origHeight; }
    resizeWidth.addEventListener('input', function() {
      if (blockResizeSync) return;
      blockResizeSync = true;
      let selectedUnit = getSelectedUnit();
      let w = resizeWidth.value ? parseFloat(resizeWidth.value) : null;
      if (isAspectLocked && w && origWidth && origHeight) {
        let ratio = aspectRatio(), h = w / ratio;
        if (selectedUnit === 'cm' || selectedUnit === 'inch') resizeHeight.value = h ? parseFloat(h).toFixed(DECIMALS) : '';
        else resizeHeight.value = h ? Math.round(h) : '';
      }
      blockResizeSync = false;
    });
    resizeHeight.addEventListener('input', function() {
      if (blockResizeSync) return;
      blockResizeSync = true;
      let selectedUnit = getSelectedUnit();
      let h = resizeHeight.value ? parseFloat(resizeHeight.value) : null;
      if (isAspectLocked && h && origWidth && origHeight) {
        let ratio = aspectRatio(), w = h * ratio;
        if (selectedUnit === 'cm' || selectedUnit === 'inch') resizeWidth.value = w ? parseFloat(w).toFixed(DECIMALS) : '';
        else resizeWidth.value = w ? Math.round(w) : '';
      }
      blockResizeSync = false;
    });

    resetResize.addEventListener('click', function() { if (loadedImage) updateUnitLabels(true); });

    // Zoom handlers
    function showZoom(src) { zoomImg.src = src; zoomModal.style.display = 'flex'; }
    originalPreview.addEventListener('click', () => { if (originalPreview.src) showZoom(originalPreview.src); });
    compressedPreview.addEventListener('click', () => { if (compressedPreview.src) showZoom(compressedPreview.src); });
    zoomModal.addEventListener('click', () => { zoomModal.style.display = 'none'; });

    // Crop handlers
    openCropBtn.addEventListener('click', function() {
      if (!originalPreview.src) return;
      cropImg.src = originalPreview.src;
      cropModal.style.display = 'flex';
      if (cropper) cropper.destroy();
      cropImg.onload = function() {
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropImg, { aspectRatio: false, viewMode: 1, autoCropArea: 1 });
      };
    });
    cropCancelBtn.addEventListener('click', function() {
      cropModal.style.display = 'none';
      if (cropper) { cropper.destroy(); cropper = null; }
    });
    cropConfirmBtn.addEventListener('click', function() {
      if (!cropper) return;
      cropper.getCroppedCanvas().toBlob(function(blob) {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        originalPreview.src = url;
        rotation = 0;
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          loadedImage = img; origWidth = img.width; origHeight = img.height;
          originalInfo.innerHTML = `Format: ${blob.type.replace('image/', '').toUpperCase()}<br>Size: ${(blob.size/1024).toFixed(2)} KB`;
          resetCompressed();
          updateUnitLabels(true);
        };
        img.src = url;
        cropModal.style.display = 'none';
        if (cropper) { cropper.destroy(); cropper = null; }
      }, originalType || "image/png");
    });

    // Rotate
    rotateBtn.addEventListener('click', function() {
      if (!loadedImage) return;
      if (loadedImage.width > 3000 || loadedImage.height > 3000) {
        msg.textContent = "Warning: Large image, rotation may take time!";
      }
      rotation = (rotation + 90) % 360;
      drawRotatedImage(loadedImage, rotation, function(dataUrl, w, h) {
        originalPreview.src = dataUrl;
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          loadedImage = img; origWidth = img.width; origHeight = img.height;
          originalInfo.innerHTML = `Format: ${originalType.replace('image/', '').toUpperCase()}<br>Size: ${(originalFile.size/1024).toFixed(2)} KB`;
          resetCompressed(); updateUnitLabels(true); msg.textContent = "";
        };
        img.onerror = function() { msg.textContent = "Rotation failed." };
        img.src = dataUrl;
      });
    });

    function drawRotatedImage(img, angle, cb) {
      try {
        let canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
        let w = img.width, h = img.height;
        if (angle % 180 !== 0) { canvas.width = h; canvas.height = w; }
        else { canvas.width = w; canvas.height = h; }
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(angle * Math.PI/180);
        ctx.drawImage(img, -w/2, -h/2);
        ctx.restore();
        cb(canvas.toDataURL(), canvas.width, canvas.height);
      } catch(err) { msg.textContent = "Image rotation error."; }
    }

    function resetCompressed() {
      compressedPreview.style.display = 'none';
      compressedInfo.innerHTML = '';
      downloadBtn.disabled = true;
      compressedBlob = null;
    }

    function filterSaveAsOptions(type) {
      const hide = [];
      switch(type) {
        case "heic": case "heif": hide.push("image/heic","image/heif","image/bmp"); break;
        case "bmp": hide.push("image/heic","image/heif"); break;
        case "jpeg": hide.push("image/heic","image/heif","image/bmp"); break;
        case "webp": hide.push("image/heic","image/heif","image/bmp"); break;
        case "avif": hide.push("image/heic","image/heif","image/bmp"); break;
        default: break;
      }
      Array.from(saveFormat.options).forEach(opt => { if (hide.includes(opt.value)) opt.style.display='none'; else opt.style.display=''; });
    }

    // Main file handler (kept logic)
    async function handleFile(file) {
      msg.textContent = '';
      rotation = 0;
      aspectLock.checked = true;
      isAspectLocked = aspectLock.checked;
      let ext = (file.name||"").toLowerCase().split('.').pop();
      let type = file.type || "";

      // reject problematic formats (as in original)
      if ((type === "image/svg+xml") || (ext === "svg")) {
        msg.textContent = "SVG is not supported for compress/convert.";
        originalPreview.style.display = 'none';
        compressBtn.disabled = true;
        openCropBtn.style.display = 'none';
        rotateBtn.style.display = 'none';
        originalInfo.innerHTML = '';
        resetCompressed();
        return;
      }
      if (type === "image/gif" || ext === "gif") {
        msg.textContent = "GIF is not supported for compress/convert.";
        originalPreview.style.display = 'none';
        compressBtn.disabled = true;
        openCropBtn.style.display = 'none';
        rotateBtn.style.display = 'none';
        originalInfo.innerHTML = '';
        resetCompressed();
        return;
      }
      if (type === "image/tiff" || type === "image/x-tiff" || ext === "tiff" || ext === "tif") {
        msg.textContent = "TIFF is not supported for compress/convert.";
        originalPreview.style.display = 'none';
        compressBtn.disabled = true;
        openCropBtn.style.display = 'none';
        rotateBtn.style.display = 'none';
        originalInfo.innerHTML = '';
        resetCompressed();
        return;
      }

      // HEIC/HEIF conversion
      if (type === "image/heic" || type === "image/heif" || ext === "heic" || ext === "heif") {
        msg.textContent = "";
        try {
          let result = await heic2any({blob: file, toType: "image/jpeg", quality: 0.95});
          let blobOut = Array.isArray(result) ? result[0] : result;
          let url = URL.createObjectURL(blobOut);
          originalPreview.src = url; originalPreview.style.display = 'block';
          compressBtn.disabled = false;
          openCropBtn.style.display = 'inline-block';
          rotateBtn.style.display = 'inline-block';
          loadedImage = new Image();
          loadedImage.crossOrigin = "anonymous";
          loadedImage.onload = function() {
            origWidth = loadedImage.width; origHeight = loadedImage.height;
            originalInfo.innerHTML = `Format: ${type === "image/heic" ? "HEIC" : "HEIF"}<br>Size: ${(file.size/1024).toFixed(2)} KB`;
            resetCompressed(); updateUnitLabels(true);
          };
          loadedImage.src = url;
          originalFile = file;
          originalType = type;
          qualityRow.style.display = "";
          saveFormat.value = type;
          filterSaveAsOptions(type === "image/heic" ? "heic" : "heif");
        } catch (err) {
          msg.textContent = "HEIC/HEIF preview failed.";
        }
        return;
      }

      // Generic image handling
      originalFile = file;
      originalType = type || ("image/" + ext);
      if (type === "image/png" || ext === "png") qualityRow.style.display = "none"; else qualityRow.style.display = "";

      document.querySelector('input[name="resizeUnit"][value="cm"]').checked = true;
      updateUnitLabels(true);

      if (type === "image/bmp" || type === "image/x-ms-bmp" || ext === "bmp") { saveFormat.value = "image/bmp"; filterSaveAsOptions("bmp"); }
      else if (type === "image/jpeg" || ext === "jpg" || ext === "jpeg") { saveFormat.value = "image/jpeg"; filterSaveAsOptions("jpeg"); }
      else if (type === "image/png" || ext === "png") { saveFormat.value = "image/png"; filterSaveAsOptions("png"); }
      else if (type === "image/webp" || ext === "webp") { saveFormat.value = "image/webp"; filterSaveAsOptions("webp"); }
      else if (type === "image/avif" || ext === "avif") { saveFormat.value = "image/avif"; filterSaveAsOptions("avif"); }
      else { saveFormat.value = "auto"; filterSaveAsOptions("default"); }

      try {
        const reader = new FileReader();
        reader.onload = function (e) {
          originalPreview.src = e.target.result; originalPreview.style.display = 'block';
          compressBtn.disabled = false; openCropBtn.style.display = 'inline-block'; rotateBtn.style.display = 'inline-block';
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = function() {
            loadedImage = img; origWidth = img.width; origHeight = img.height;
            originalInfo.innerHTML = `Format: ${(type || ext).replace('image/','').toUpperCase()}<br>Size: ${(file.size/1024).toFixed(2)} KB`;
            resetCompressed(); updateUnitLabels(true);
          };
          img.onerror = function() {
            msg.textContent = "Image could not be loaded.";
            originalPreview.style.display = 'none';
            openCropBtn.style.display = 'none';
            rotateBtn.style.display = 'none';
            originalInfo.innerHTML = '';
            compressBtn.disabled = true;
            resetCompressed();
          };
          img.src = e.target.result;
        };
        reader.onerror = function() { msg.textContent = "File could not be read."; };
        reader.readAsDataURL(file);
      } catch(err) { msg.textContent = "Error loading file."; }
    }

    // Compression button
    compressBtn.addEventListener('click', async function() {
      msg.textContent = "";
      if (!loadedImage) { msg.textContent = "No image loaded!"; return; }

      let outMime = saveFormat.value === "auto" ? originalType : saveFormat.value;
      let quality = parseInt(qualityRange.value) / 100;
      let selectedUnit = getSelectedUnit();
      let width = parseFloat(resizeWidth.value) || loadedImage.width;
      let height = parseFloat(resizeHeight.value) || loadedImage.height;
      if (selectedUnit === 'cm') { width = unitConvert(width, 'cm', 'px'); height = unitConvert(height, 'cm', 'px'); }
      else if (selectedUnit === 'inch') { width = unitConvert(width, 'inch', 'px'); height = unitConvert(height, 'inch', 'px'); }
      width = Math.round(width); height = Math.round(height);
      let canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
      let ctx = canvas.getContext('2d');
      ctx.drawImage(loadedImage, 0, 0, width, height);
      let dataUrl, blob;
      try {
        if (outMime === "image/png") {
          dataUrl = canvas.toDataURL("image/png"); blob = await (await fetch(dataUrl)).blob();
        } else if (outMime === "image/jpeg" || outMime === "image/jpg") {
          dataUrl = canvas.toDataURL("image/jpeg", quality); blob = await (await fetch(dataUrl)).blob();
        } else if (outMime === "image/webp") {
          dataUrl = canvas.toDataURL("image/webp", quality); blob = await (await fetch(dataUrl)).blob();
        } else if (outMime === "image/bmp") {
          dataUrl = canvas.toDataURL("image/bmp"); blob = await (await fetch(dataUrl)).blob();
        } else if (outMime === "image/avif" && canvas.toDataURL("image/avif")) {
          try {
            dataUrl = canvas.toDataURL("image/avif", quality); blob = await (await fetch(dataUrl)).blob();
          } catch(e) {
            dataUrl = canvas.toDataURL("image/png"); blob = await (await fetch(dataUrl)).blob(); outMime = "image/png";
          }
        } else {
          dataUrl = canvas.toDataURL("image/jpeg", quality); blob = await (await fetch(dataUrl)).blob(); outMime = "image/jpeg";
        }
      } catch(e) {
        msg.textContent = "Compression failed: " + e.message;
        return;
      }
      compressedBlob = blob;
      compressedPreview.src = dataUrl; compressedPreview.style.display = 'block';
      compressedInfo.innerHTML = `Format: ${outMime.replace('image/', '').toUpperCase()}<br>Size: ${(blob.size/1024).toFixed(2)} KB`;
      downloadBtn.disabled = false;
      lastOutMime = outMime;
      msg.textContent = "Compression done!";
      setTimeout(()=> msg.textContent = "", 1200);
    });

    // Download
    downloadBtn.addEventListener('click', function() {
      if (!compressedBlob) { msg.textContent = "No compressed image to download!"; return; }
      let ext = (lastOutMime === "image/jpeg") ? "jpg"
              : (lastOutMime === "image/png") ? "png"
              : (lastOutMime === "image/webp") ? "webp"
              : (lastOutMime === "image/avif") ? "avif"
              : (lastOutMime === "image/bmp") ? "bmp"
              : "jpg";
      let filename = "compressed_image";
      if (enableSaveAs.checked && saveFilename.value.trim()) filename = saveFilename.value.trim();
      filename += "." + ext;
      let url = URL.createObjectURL(compressedBlob);
      let a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); document.body.removeChild(a); }, 200);
    });

    // More Tools button - opens skycommunics site in new tab
    moreToolsBtn && moreToolsBtn.addEventListener('click', function() {
      // opens skycommunics main landing where future tools and Kill File will be reachable
      window.open('https://skycommunics.com', '_blank', 'noopener');
    });

    // Nav toggle simple
    const navToggle = document.querySelector('.nav-toggle');
    navToggle && navToggle.addEventListener('click', function() {
      document.querySelector('nav').classList.toggle('show-menu');
    });

    // Zoom modal close by Escape
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { zoomModal.style.display = 'none'; cropModal.style.display = 'none'; aboutModalBg.style.display = 'none'; document.body.style.overflow = ''; }});

    // Expose handleFile to file inputs drop handlers (already wired)
    window.handleFile = handleFile;

    // Register service worker safely
    if ('serviceWorker' in navigator) {
      try {
        navigator.serviceWorker.register('/service-worker.js').catch(()=>{ /* ignore registration errors */ });
      } catch (e) { /* ignore */ }
    }
  });
  </script>
</body>
</html>