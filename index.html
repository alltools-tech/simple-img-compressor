<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>Free Image Compressor & Converter Online | Smart Image Compressor</title>
  <meta name="description" content="Compress and convert images (JPEG, PNG, WebP) online for free. 100% secure — works in browser, no upload needed. Fast & privacy-friendly.">
  <meta name="keywords" content="free image compressor, online image converter, compress JPEG, compress PNG, WebP compressor, image resize tool">
  <meta name="author" content="Smart Image Compressor">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://simple-img-compressor.vercel.app/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://simple-img-compressor.vercel.app/">
  <meta property="og:title" content="Free Image Compressor & Converter Online">
  <meta property="og:description" content="Compress and convert JPEG, PNG, WebP images online for free. No uploads. Fast & secure.">
  <meta property="og:image" content="https://simple-img-compressor.vercel.app/og-image.jpg">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://simple-img-compressor.vercel.app/">
  <meta name="twitter:title" content="Free Image Compressor & Converter Online">
  <meta name="twitter:description" content="Compress and convert JPEG, PNG, WebP images online for free. No uploads. Fast & secure.">
  <meta name="twitter:image" content="https://simple-img-compressor.vercel.app/og-image.jpg">

  <!-- Favicon -->
  <link rel="icon" href="https://simple-img-compressor.vercel.app/favicon.ico" type="image/x-icon">

  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Smart Image Compressor",
    "url": "https://simple-img-compressor.vercel.app/",
    "description": "Free, fast and secure online tool to compress and convert JPEG, PNG, WebP images.",
    "applicationCategory": "MultimediaApplication",
    "operatingSystem": "All",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-R0K1T489JY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-R0K1T489JY');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js?client=ca-pub-7604876231244458" crossorigin="anonymous"></script>

  <!-- Fonts & Styles -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    body {font-family: 'Inter', Arial, sans-serif;margin: 0; padding: 0;background: linear-gradient(120deg, #e3f2fd 0%, #fffde7 100%);color: #222;}
    header {background: #272a36;color: #fff;padding: 1.5em 0 1em;text-align: center;font-size: 2em;font-weight: 700;letter-spacing: .03em;border-bottom: 2px solid #2196f3;box-shadow: 0 2px 12px rgba(33,150,243,0.09);}
    main {max-width: 980px;margin: 2em auto;background: #fff;padding: 2em 2em 1em;border-radius: 16px;box-shadow: 0 4px 32px rgba(33,150,243,0.07);}
    .upload-zone {border: 2px dashed #90caf9;border-radius: 10px;background: #e3f2fd;padding: 2em 1em;text-align: center;color: #1976d2;font-size: 1.15em;margin-bottom: 1.5em;cursor: pointer;transition: background 0.2s;}
    .upload-zone.dragover {background: #bbdefb;border-color: #2196f3;color: #0d47a1;}
    .upload-btn-group {margin-top: 1em;display: flex;gap: 1em;justify-content: center;flex-wrap: wrap;}
    .upload-btn {padding: .65em 1.4em;background: linear-gradient(90deg, #2196f3 60%, #21cbf3);color: #fff; border: none; border-radius: 6px;font-weight: 700; font-size: 1em;cursor: pointer; transition: background .18s;}
    .supported-types {color: #1565c0;font-size: .98em;margin-top: 10px;background: #e8eaf6;border-radius: 5px;display: inline-block;padding: 4px 14px;font-weight: 500;}
    .preview-row {display: flex;gap: 2em;align-items: flex-start;margin-bottom: 1em;justify-content: center;}
    @media(max-width:700px){.preview-row { flex-direction: column; gap: 1em;}main { padding: 1em;}.upload-btn-group { flex-direction: column; gap: .7em;}}
    .card {background: #f7fbff;border-radius: 10px;box-shadow: 0 2px 12px rgba(33,150,243,0.04);padding: 1.3em 1em .7em 1em;min-width: 250px;text-align: center;flex: 1;position: relative;}
    .preview-img {
      width: 100%;
      max-width: 300px;
      max-height: 200px;
      border-radius: 8px;
      margin-bottom: .4em;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(33,150,243,0.09);
      background: repeating-linear-gradient(
        135deg,
        #e3f2fd 0px, #e3f2fd 20px,
        #f8bbd0 20px, #f8bbd0 40px
      );
      outline: 2px solid #90caf9;
      outline-offset: 2px;
      transition: box-shadow .2s, outline-color .2s;
      display: block;
      margin-left: auto;
      margin-right: auto;
      object-fit: contain;
      background-color: #fff;
    }
    .preview-img:hover { box-shadow: 0 8px 32px #42a5f5aa; outline-color: #1976d2;}
    .zoom-modal {display: none; position: fixed; z-index: 99;left: 0; top: 0; width: 100vw; height: 100vh;background: rgba(33,150,243,0.15);align-items: center; justify-content: center;}
    .zoom-modal img {max-width: 90vw; max-height: 90vh; border-radius: 12px;box-shadow: 0 4px 40px #2196f3bb;background: #fff;}
    .info-row {font-size: 1em;color: #2e7d32;margin-bottom: .7em;line-height: 1.4;}
    label { display: block; margin:1em 0 .5em;}
    input[type="range"] { width: 100%; margin-bottom: .2em;}
    .range-row { display: flex; align-items: center; gap: 1em;}
    .range-row span {font-size: .97em;font-weight: 500;color: #1976d2;background: #e3f2fd;border-radius: 4px;padding: 2px 8px;margin-left: 7px;}
    .resize-unit-group {display: flex;gap: .8em;margin-bottom: .7em;align-items: center;font-size: .99em;}
    .resize-unit-label {color: #1976d2;font-weight: 600;margin-right: 8px;}
    .aspect-lock-row { display: flex; align-items: center; gap: 0.8em; margin-bottom: 0.5em; font-size: .99em;}
    .aspect-lock-label { color: #1976d2; font-weight: 600; }
    .aspect-lock-checkbox { width: 1.15em; height: 1.15em; }
    .error-msg { color: #cb2431; font-size: 1em; margin-top: .6em;}
    .success-msg { color: #388e3c; font-size: 1em; margin-top: .6em;}
    .btn {padding: .6em 1.5em;background: linear-gradient(90deg, #2196f3 60%, #21cbf3);color: #fff; border: none; border-radius: 6px;font-weight: 700; font-size: 1em;cursor: pointer; transition: background .18s;}
    .btn:disabled { background: #aec4e6; cursor: not-allowed;}
    .reset-btn {padding: .4em 1.1em;background: #bbb;color: #fff;border: none;border-radius: 4px;font-size: .97em;font-weight: 600;margin-left: 16px;cursor: pointer;transition: background .13s;}
    .reset-btn:hover { background: #757575;}
    .footer {text-align: center;color: #999;font-size: .98em;margin: 2.5em 0 0.3em;letter-spacing: .02em;}
    #about-link {display:inline-block; color:#2196f3;font-weight:500; text-decoration:none; margin-left:15px;}
    #about-popup {display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(33,150,243,.11); z-index:999; align-items:center; justify-content:center;}
    #about-popup-content {background:#fff;padding:2em 1.5em;max-width:500px;border-radius:16px;box-shadow:0 4px 32px rgba(33,150,243,0.10);}
    #about-popup h2 {color:#1976d2;margin-top:0;}
    #about-popup ul {margin-left:1.2em;}
    #about-close {background:#2196f3;color:#fff;border:none;border-radius:6px;padding:.5em 1em;font-size:1em;font-weight:600;margin-top:1em;cursor:pointer;}
  </style>
</head>
<body>
  <header>
    <h1>Smart Image Compressor & Convertor in just one click</h1>
  </header>
  <main>
    <div class="upload-zone" id="uploadZone">
      <div><b>Drag &amp; Drop</b> or use <b>buttons below</b> to upload/capture image</div>
      <div class="supported-types">Supported: JPEG, PNG, WebP</div>
      <div class="upload-btn-group">
        <button class="upload-btn" id="galleryBtn" type="button">Upload from Gallery</button>
        <button class="upload-btn" id="cameraBtn" type="button">Capture from Camera</button>
      </div>
      <input type="file" id="galleryInput" accept="image/jpeg,image/png,image/webp,image/*" style="display:none">
      <input type="file" id="cameraInput" accept="image/jpeg,image/png,image/webp,image/*" capture="environment" style="display:none">
    </div>
    <div class="preview-row">
      <div class="card" id="originalCard">
        <div style="font-weight:600; margin-bottom:5px;">Original</div>
        <img id="originalPreview" class="preview-img" src="" alt="Original Image Preview" style="display:none;" crossorigin="anonymous">
        <div style="margin-top:10px;">
          <button id="openCropBtn" class="btn" style="display:none;">Crop Image</button>
          <button id="rotateBtn" class="btn" style="display:none;">Rotate 90°</button>
        </div>
        <div class="info-row" id="originalInfo"></div>
      </div>
      <div class="card" id="compressedCard">
        <div style="font-weight:600; margin-bottom:5px;">Compressed</div>
        <img id="compressedPreview" class="preview-img" src="" alt="Compressed Image Preview" style="display:none;" crossorigin="anonymous">
        <div class="info-row" id="compressedInfo"></div>
      </div>
    </div>
    <div style="margin:1.5em 0 1em 0;">
      <div class="range-row" id="qualityRow">
        <label for="qualityRange">Quality:</label>
        <input type="range" id="qualityRange" min="10" max="100" value="80">
        <span id="qualityValue">80</span>%
      </div>
      <div class="resize-unit-group">
        <span class="resize-unit-label">Resize Units:</span>
        <label><input type="radio" name="resizeUnit" value="cm" checked> cm</label>
        <label><input type="radio" name="resizeUnit" value="inch"> inch</label>
        <label><input type="radio" name="resizeUnit" value="px"> px</label>
      </div>
      <!-- Aspect Lock Option -->
      <div class="aspect-lock-row">
        <label class="aspect-lock-label">
          <input type="checkbox" id="aspectLock" class="aspect-lock-checkbox" checked>
          Lock Aspect Ratio
        </label>
      </div>
      <div class="range-row">
        <label for="resizeWidth">Width (<span id="unitLabelW">cm</span>):</label>
        <input type="number" id="resizeWidth" min="0.0001" step="any" placeholder="Original width" style="width:90px;">
      </div>
      <div class="range-row">
        <label for="resizeHeight">Height (<span id="unitLabelH">cm</span>):</label>
        <input type="number" id="resizeHeight" min="0.0001" step="any" placeholder="Original height" style="width:90px;">
        <button id="resetResize" class="reset-btn" type="button" title="Reset to original">Reset</button>
      </div>
      <div style="margin:1em 0;">
        <label>
          <input type="checkbox" id="enableSaveAs" checked>
          Save image as
        </label>
        <input type="text" id="saveFilename" style="width:160px;" placeholder="compressed_image">
        <select id="saveFormat" class="select-format">
          <option value="auto">Same as original</option>
          <option value="image/jpeg">JPEG (.jpg)</option>
          <option value="image/png">PNG (.png)</option>
          <option value="image/webp">WebP (.webp)</option>
        </select>
      </div>
      <button id="compressBtn" class="btn" disabled>Compress Image</button>
      <button id="downloadBtn" class="btn" disabled>Download Compressed</button>
      <span id="msg" class="error-msg"></span>
    </div>
    <div class="zoom-modal" id="zoomModal">
      <img id="zoomImg" src="" alt="Zoomed image">
    </div>
    <div class="zoom-modal" id="cropModal">
      <div style="background:#fff; padding:18px 14px; border-radius:10px; max-width:99vw; max-height:96vh;">
        <img id="cropImg" src="" style="max-width:80vw; max-height:60vh;" crossorigin="anonymous">
        <div style="text-align:center; margin-top:12px;">
          <button id="cropConfirmBtn" class="btn">Crop &amp; Use</button>
          <button id="cropCancelBtn" class="reset-btn">Cancel</button>
        </div>
      </div>
    </div>
  </main>
  <div class="footer">
    &copy; 2025 Smart Image Compressor | Fast, Free & Secure
    <a id="about-link" href="#">About</a>
  </div>
  <!-- About Popup -->
  <div id="about-popup">
    <div id="about-popup-content">
      <h2>About Smart Image Compressor</h2>
      <p>
        <strong>Smart Image Compressor</strong> is a free, fast, and secure online tool for compressing and resizing images. It supports JPEG, PNG, and WebP formats. The app is designed for simplicity, privacy, and speed.
      </p>
      <h3>Features</h3>
      <ul>
        <li>Supports JPEG, PNG, and WebP images</li>
        <li>Compress images with adjustable quality</li>
        <li>Resize by pixels, centimeters, or inches</li>
        <li>Crop and rotate images before compression</li>
        <li>Preview original and compressed images side-by-side</li>
        <li>Download compressed images with custom filenames</li>
        <li>Works entirely in your browser—no image is uploaded to a server</li>
      </ul>
      <h3>Privacy & Security</h3>
      <ul>
        <li>Your images never leave your device</li>
        <li>Compression is handled locally in your browser using HTML5 Canvas</li>
        <li>No images are stored, shared, or sent over the internet</li>
      </ul>
      <h3>Technology Used</h3>
      <ul>
        <li>HTML5, CSS3, and JavaScript</li>
        <li>Canvas API for image processing</li>
        <li><a href="https://fengyuanchen.github.io/cropperjs/" target="_blank">CropperJS</a> for cropping functionality</li>
        <li>Responsive design for mobile and desktop</li>
      </ul>
      <h3>How to Use?</h3>
      <ul>
        <li>Upload or capture an image from your device</li>
        <li>Adjust quality, resize, crop, or rotate as needed</li>
        <li>Click 'Compress Image' and preview the result</li>
        <li>Download the compressed image for use anywhere</li>
      </ul>
      <h3>Contact & Feedback</h3>
      <p>
        If you have suggestions or found a bug, please reach out at 
        <a href="mailto:skycommunics@gmail.com">skycommunics@gmail.com</a>.
      </p>
      <button id="about-close">Close</button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      var aboutLink = document.getElementById('about-link');
      var aboutPopup = document.getElementById('about-popup');
      var aboutClose = document.getElementById('about-close');
      aboutLink.addEventListener('click', function(e){
        e.preventDefault();
        aboutPopup.style.display = 'flex';
      });
      aboutClose.addEventListener('click', function(){
        aboutPopup.style.display = 'none';
      });
      aboutPopup.addEventListener('click', function(e){
        if(e.target === aboutPopup) aboutPopup.style.display = 'none';
      });

      // Compressor JS code
      const DECIMALS = 4;
      function getDPI() { return 96; }
      function unitConvert(val, from, to) {
        if (!val) return '';
        const dpi = getDPI();
        switch(from + '-' + to) {
          case 'px-cm': return (val / dpi * 2.54).toFixed(DECIMALS);
          case 'px-inch': return (val / dpi).toFixed(DECIMALS);
          case 'cm-px': return Math.round(val * dpi / 2.54);
          case 'inch-px': return Math.round(val * dpi);
          default: return val;
        }
      }
      const galleryBtn = document.getElementById('galleryBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const galleryInput = document.getElementById('galleryInput');
      const cameraInput = document.getElementById('cameraInput');
      const uploadZone = document.getElementById('uploadZone');
      const originalPreview = document.getElementById('originalPreview');
      const compressedPreview = document.getElementById('compressedPreview');
      const originalInfo = document.getElementById('originalInfo');
      const compressedInfo = document.getElementById('compressedInfo');
      const qualityRange = document.getElementById('qualityRange');
      const qualityValue = document.getElementById('qualityValue');
      const resizeWidth = document.getElementById('resizeWidth');
      const resizeHeight = document.getElementById('resizeHeight');
      const unitRadios = document.getElementsByName('resizeUnit');
      const unitLabelW = document.getElementById('unitLabelW');
      const unitLabelH = document.getElementById('unitLabelH');
      const compressBtn = document.getElementById('compressBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const resetResize = document.getElementById('resetResize');
      const msg = document.getElementById('msg');
      const zoomModal = document.getElementById('zoomModal');
      const zoomImg = document.getElementById('zoomImg');
      const openCropBtn = document.getElementById('openCropBtn');
      const cropModal = document.getElementById('cropModal');
      const cropImg = document.getElementById('cropImg');
      const cropConfirmBtn = document.getElementById('cropConfirmBtn');
      const cropCancelBtn = document.getElementById('cropCancelBtn');
      const saveFilename = document.getElementById('saveFilename');
      const enableSaveAs = document.getElementById('enableSaveAs');
      const saveFormat = document.getElementById('saveFormat');
      const qualityRow = document.getElementById('qualityRow');
      const rotateBtn = document.getElementById('rotateBtn');
      const aspectLock = document.getElementById('aspectLock');
      let cropper = null;

      let originalFile = null;
      let compressedBlob = null;
      let loadedImage = null;
      let originalType = "";
      let origWidth = null, origHeight = null;
      let blockResizeSync = false;
      let lastOutMime = "";
      let rotation = 0;
      let isAspectLocked = aspectLock ? aspectLock.checked : true;

      galleryBtn.addEventListener('click', function() {
        galleryInput.value = ""; // reset file input
        galleryInput.click();
      });
      cameraBtn.addEventListener('click', function() {
        cameraInput.value = ""; // reset file input
        cameraInput.click();
      });

      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });
      uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
      });
      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          handleFile(e.dataTransfer.files[0]);
        }
      });

      galleryInput.addEventListener('change', function() {
        if (this.files && this.files[0]) handleFile(this.files[0]);
      });
      cameraInput.addEventListener('change', function() {
        if (this.files && this.files[0]) handleFile(this.files[0]);
      });

      aspectLock.addEventListener('change', () => {
        isAspectLocked = aspectLock.checked;
      });

      function handleFile(file) {
        msg.textContent = '';
        rotation = 0;
        aspectLock.checked = true;
        isAspectLocked = true;
        if (file && ["image/jpeg", "image/png", "image/webp"].includes(file.type)) {
          originalFile = file;
          originalType = file.type;
          if (file.type === "image/png") {
            qualityRow.style.display = "none";
          } else {
            qualityRow.style.display = "";
          }
          document.querySelector('input[name="resizeUnit"][value="cm"]').checked = true;
          updateUnitLabels(true);

          if (file.type === "image/jpeg") {
            saveFormat.value = "image/jpeg";
          } else if (file.type === "image/png") {
            saveFormat.value = "image/png";
          } else if (file.type === "image/webp") {
            saveFormat.value = "image/webp";
          } else {
            saveFormat.value = "auto";
          }

          try {
            const reader = new FileReader();
            reader.onload = function(e) {
              originalPreview.src = e.target.result;
              originalPreview.style.display = 'block';
              compressBtn.disabled = false;
              openCropBtn.style.display = 'inline-block';
              rotateBtn.style.display = 'inline-block';
              const img = new Image();
              img.crossOrigin = "anonymous";
              img.onload = function() {
                loadedImage = img;
                origWidth = img.width;
                origHeight = img.height;
                originalInfo.innerHTML = `Format: ${file.type.replace('image/', '').toUpperCase()}<br>Size: ${(file.size/1024).toFixed(2)} KB`;
                resetCompressed();
                updateUnitLabels(true);
              };
              img.onerror = function() {
                msg.textContent = "Image could not be loaded.";
                originalPreview.style.display = 'none';
                openCropBtn.style.display = 'none';
                rotateBtn.style.display = 'none';
                originalInfo.innerHTML = '';
                compressBtn.disabled = true;
                resetCompressed();
              };
              img.src = e.target.result;
            };
            reader.onerror = function() {
              msg.textContent = "File could not be read.";
            };
            reader.readAsDataURL(file);
          } catch(err) {
            msg.textContent = "Error loading file.";
          }
        } else {
          msg.textContent = "Please select a valid image file (JPEG, PNG, WebP).";
          originalPreview.style.display = 'none';
          openCropBtn.style.display = 'none';
          rotateBtn.style.display = 'none';
          originalInfo.innerHTML = '';
          compressBtn.disabled = true;
          resetCompressed();
        }
      }

      function resetCompressed() {
        compressedPreview.style.display = 'none';
        compressedInfo.innerHTML = '';
        downloadBtn.disabled = true;
        compressedBlob = null;
      }

      qualityRange.addEventListener('input', function() {
        qualityValue.textContent = this.value;
      });

      function getSelectedUnit() {
        let selectedUnit = 'cm';
        unitRadios.forEach(radio => { if (radio.checked) selectedUnit = radio.value; });
        return selectedUnit;
      }
      function updateUnitLabels(forceAutofill) {
        let selectedUnit = getSelectedUnit();
        unitLabelW.textContent = selectedUnit;
        unitLabelH.textContent = selectedUnit;
        if (loadedImage) {
          const origW = loadedImage.width;
          const origH = loadedImage.height;
          if (selectedUnit === 'cm') {
            resizeWidth.placeholder = unitConvert(origW, 'px', 'cm');
            resizeHeight.placeholder = unitConvert(origH, 'px', 'cm');
            if (forceAutofill) {
              resizeWidth.value = parseFloat(unitConvert(origW, 'px', 'cm')).toFixed(DECIMALS);
              resizeHeight.value = parseFloat(unitConvert(origH, 'px', 'cm')).toFixed(DECIMALS);
            }
            resizeWidth.step = "0.0001";
            resizeHeight.step = "0.0001";
          } else if (selectedUnit === 'inch') {
            resizeWidth.placeholder = unitConvert(origW, 'px', 'inch');
            resizeHeight.placeholder = unitConvert(origH, 'px', 'inch');
            if (forceAutofill) {
              resizeWidth.value = parseFloat(unitConvert(origW, 'px', 'inch')).toFixed(DECIMALS);
              resizeHeight.value = parseFloat(unitConvert(origH, 'px', 'inch')).toFixed(DECIMALS);
            }
            resizeWidth.step = "0.0001";
            resizeHeight.step = "0.0001";
          } else {
            resizeWidth.placeholder = origW;
            resizeHeight.placeholder = origH;
            if (forceAutofill) {
              resizeWidth.value = Math.round(origW);
              resizeHeight.value = Math.round(origH);
            }
            resizeWidth.step = "1";
            resizeHeight.step = "1";
          }
        }
      }
      unitRadios.forEach(radio => radio.addEventListener('change', () => {
        updateUnitLabels(true);
      }));

      function aspectRatio() {
        if (!origWidth || !origHeight) return 1;
        return origWidth / origHeight;
      }

      // Modified: Only sync the other field if aspect lock is enabled
      resizeWidth.addEventListener('input', function() {
        if (blockResizeSync) return;
        blockResizeSync = true;
        let selectedUnit = getSelectedUnit();
        let w = resizeWidth.value ? parseFloat(resizeWidth.value) : null;
        if (isAspectLocked && w && origWidth && origHeight) {
          let ratio = aspectRatio();
          let h = w / ratio;
          if (selectedUnit === 'cm' || selectedUnit === 'inch') {
            resizeHeight.value = h ? parseFloat(h).toFixed(DECIMALS) : '';
          } else {
            resizeHeight.value = h ? Math.round(h) : '';
          }
        }
        blockResizeSync = false;
      });
      resizeHeight.addEventListener('input', function() {
        if (blockResizeSync) return;
        blockResizeSync = true;
        let selectedUnit = getSelectedUnit();
        let h = resizeHeight.value ? parseFloat(resizeHeight.value) : null;
        if (isAspectLocked && h && origWidth && origHeight) {
          let ratio = aspectRatio();
          let w = h * ratio;
          if (selectedUnit === 'cm' || selectedUnit === 'inch') {
            resizeWidth.value = w ? parseFloat(w).toFixed(DECIMALS) : '';
          } else {
            resizeWidth.value = w ? Math.round(w) : '';
          }
        }
        blockResizeSync = false;
      });

      resetResize.addEventListener('click', function() {
        if (loadedImage) {
          updateUnitLabels(true);
        }
      });

      compressBtn.addEventListener('click', function() {
        msg.textContent = '';
        if (!originalFile || !loadedImage) return;
        let width = loadedImage.width;
        let height = loadedImage.height;
        let selectedUnit = getSelectedUnit();
        let wVal = resizeWidth.value;
        let hVal = resizeHeight.value;
        if (wVal) {
          if (selectedUnit === "cm") width = unitConvert(wVal, "cm", "px");
          else if (selectedUnit === "inch") width = unitConvert(wVal, "inch", "px");
          else width = parseInt(wVal);
        }
        if (hVal) {
          if (selectedUnit === "cm") height = unitConvert(hVal, "cm", "px");
          else if (selectedUnit === "inch") height = unitConvert(hVal, "inch", "px");
          else height = parseInt(hVal);
        }
        if (width <= 0 || height <= 0) {
          msg.textContent = "Resize dimensions must be positive.";
          return;
        }
        try {
          let canvas = document.createElement('canvas');
          let ctx = canvas.getContext('2d');
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(loadedImage, 0, 0, width, height);

          let outMime = originalType;
          let quality = parseInt(qualityRange.value) / 100;

          if (saveFormat.value !== "auto") {
            outMime = saveFormat.value;
          } else {
            if (originalType === "image/png") {
              outMime = "image/png";
              quality = undefined;
            }
            if (originalType === "image/jpeg") {
              outMime = "image/jpeg";
            }
            if (originalType === "image/webp") {
              outMime = "image/webp";
            }
          }

          lastOutMime = outMime;
          canvas.toBlob(function(blob) {
            if (!blob) {
              msg.textContent = "Compression failed.";
              return;
            }
            compressedBlob = blob;
            const url = URL.createObjectURL(blob);
            compressedPreview.src = url;
            compressedPreview.style.display = 'block';
            compressedInfo.innerHTML = `Format: ${blob.type.replace('image/', '').toUpperCase()}<br>Size: ${(blob.size/1024).toFixed(2)} KB`;
            downloadBtn.disabled = false;
            msg.textContent = '';
          }, outMime, quality);
        } catch(err) {
          msg.textContent = "Compression error.";
        }
      });

      enableSaveAs.addEventListener("change", function() {
        if (enableSaveAs.checked) {
          saveFilename.disabled = false;
          saveFilename.style.opacity = "1";
        } else {
          saveFilename.disabled = true;
          saveFilename.style.opacity = "0.6";
        }
      });

      downloadBtn.addEventListener('click', function() {
        if (!compressedBlob) return;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(compressedBlob);
        let ext = "";
        switch (lastOutMime) {
          case "image/jpeg": ext = ".jpg"; break;
          case "image/png": ext = ".png"; break;
          case "image/webp": ext = ".webp"; break;
          default: ext = ".png";
        }
        let baseName = "image";
        if (enableSaveAs.checked) {
          baseName = saveFilename.value.trim() || (originalFile ? originalFile.name.replace(/\.[^/.]+$/, "") : "image");
        } else {
          baseName = originalFile ? originalFile.name.replace(/\.[^/.]+$/, "") : "image";
        }
        let suggestedName = baseName + ext;
        a.download = suggestedName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      function showZoom(src) {
        zoomImg.src = src;
        zoomModal.style.display = 'flex';
      }
      originalPreview.addEventListener('click', () => { if (originalPreview.src) showZoom(originalPreview.src); });
      compressedPreview.addEventListener('click', () => { if (compressedPreview.src) showZoom(compressedPreview.src); });
      zoomModal.addEventListener('click', () => { zoomModal.style.display = 'none'; });

      openCropBtn.addEventListener('click', function() {
        if (!originalPreview.src) return;
        cropImg.src = originalPreview.src;
        cropModal.style.display = 'flex';
        if (cropper) { cropper.destroy(); }
        cropImg.onload = function() {
          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImg, {
            aspectRatio: false,
            viewMode: 1,
            autoCropArea: 1
          });
        };
      });
      cropCancelBtn.addEventListener('click', function() {
        cropModal.style.display = 'none';
        if (cropper) cropper.destroy();
      });
      cropConfirmBtn.addEventListener('click', function() {
        if (!cropper) return;
        cropper.getCroppedCanvas().toBlob(function(blob) {
          if (!blob) return;
          const url = URL.createObjectURL(blob);
          originalPreview.src = url;
          rotation = 0; // Reset rotation after crop
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = function() {
            loadedImage = img;
            origWidth = img.width;
            origHeight = img.height;
            originalInfo.innerHTML = `Format: ${blob.type.replace('image/', '').toUpperCase()}<br>Size: ${(blob.size/1024).toFixed(2)} KB`;
            resetCompressed();
            updateUnitLabels(true);
          };
          img.src = url;
          cropModal.style.display = 'none';
          if (cropper) cropper.destroy();
        }, originalType || "image/png");
      });

      rotateBtn.addEventListener('click', function() {
        if (!loadedImage) return;
        if (loadedImage.width > 3000 || loadedImage.height > 3000) {
          msg.textContent = "Warning: Large image, rotation may take time!";
        }
        rotation = (rotation + 90) % 360;
        drawRotatedImage(loadedImage, rotation, function(dataUrl, w, h) {
          originalPreview.src = dataUrl;
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = function() {
            loadedImage = img;
            origWidth = img.width;
            origHeight = img.height;
            originalInfo.innerHTML = `Format: ${originalType.replace('image/', '').toUpperCase()}<br>Size: ${(originalFile.size/1024).toFixed(2)} KB`;
            resetCompressed();
            updateUnitLabels(true);
            msg.textContent = ""; // clear
          };
          img.onerror = function() {
            msg.textContent = "Rotation failed.";
          };
          img.src = dataUrl;
        });
      });

      function drawRotatedImage(img, angle, cb) {
        try {
          let canvas = document.createElement('canvas');
          let ctx = canvas.getContext('2d');
          let w = img.width, h = img.height;
          if (angle % 180 !== 0) {
            canvas.width = h;
            canvas.height = w;
          } else {
            canvas.width = w;
            canvas.height = h;
          }
          ctx.save();
          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate(angle * Math.PI / 180);
          ctx.drawImage(img, -w / 2, -h / 2);
          ctx.restore();
          cb(canvas.toDataURL(), canvas.width, canvas.height);
        } catch(err) {
          msg.textContent = "Image rotation error.";
        }
      }

      document.querySelector('input[name="resizeUnit"][value="cm"]').checked = true;
      updateUnitLabels(true);

      saveFormat.addEventListener("change", function() {
        if (saveFormat.value === "image/png") {
          qualityRow.style.display = "none";
        } else {
          qualityRow.style.display = "";
        }
      });
    });
  </script>
</body>
</html>